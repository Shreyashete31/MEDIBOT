<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Health Assistant - HealthHub</title>
  <meta name="description" content="Chat with our AI health assistant for personalized health advice and remedies">
  <meta name="theme-color" content="#009688">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealthHub Chat">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4a72e0;
      --primary-dark: #355fd0;
      --secondary-color: #5fbfa3;
      --accent-color: #e47f93;
      --text-primary: #1f2a37;
      --text-secondary: #5c6b7a;
      --background: #e2e8ff;
      --surface: #ffffff;
      --border-color: #cbd6e8;
      --shadow: 0 12px 30px rgba(74, 114, 224, 0.18);
      --shadow-hover: 0 18px 40px rgba(53, 95, 208, 0.25);
      --gradient-primary: linear-gradient(135deg, #96b5ff 0%, #dea2ff 100%);
      --bot-color: #d9e8ff;
      --user-color: #4a72e0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #dbe4ff 0%, #ffd2ec 100%);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .chat-header {
      background: var(--gradient-primary);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-hover);
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .voice-toggle {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .voice-toggle:hover {
      background: rgba(255,255,255,0.3);
    }

    .voice-toggle.active {
      background: rgba(255,255,255,0.9);
      color: var(--accent-color);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Chat Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      max-width: 80%;
      padding: 1rem 1.5rem;
      border-radius: 18px;
      position: relative;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: var(--user-color);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }

    .message.bot {
      background: var(--bot-color);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 6px;
    }

    .message-content {
      margin: 0;
      line-height: 1.5;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.5rem;
    }

    .message.user .message-time {
      text-align: right;
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      background: var(--bot-color);
      padding: 1rem 1.5rem;
      border-radius: 18px;
      border-bottom-left-radius: 6px;
      max-width: 80px;
    }

    .typing-indicator.show {
      display: block;
      animation: typingPulse 1.5s infinite;
    }

    @keyframes typingPulse {
      0%, 60%, 100% { opacity: 1; }
      30% { opacity: 0.5; }
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typingDot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingDot {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    /* Quick Suggestions */
    .suggestions-container {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      background: var(--surface);
    }

    .suggestions-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 0.5rem;
      font-weight: 500;
    }

    .suggestions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .suggestion-chip {
      background: var(--background);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .suggestion-chip:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    /* Input Area */
    .input-area {
      padding: 1rem;
      background: var(--surface);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .input-container {
      flex: 1;
      position: relative;
    }

    .message-input {
      width: 100%;
      padding: 1rem 3rem 1rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 25px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s ease;
      resize: none;
      min-height: 50px;
      max-height: 120px;
    }

    .message-input:focus {
      border-color: var(--primary-color);
    }

    .input-actions {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 0.25rem;
    }

    .input-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .input-btn:hover {
      background: var(--background);
      color: var(--primary-color);
    }

    .send-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      min-width: 50px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Welcome Message */
    .welcome-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }

    .welcome-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 0.5rem;
      color: var(--text-primary);
    }

    .welcome-text {
      margin: 0 0 1.5rem;
      line-height: 1.5;
    }

    /* Empty State */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .chat-header {
        padding: 1rem;
      }

      .header-title {
        font-size: 1.2rem;
      }

      .message {
        max-width: 90%;
      }

      .input-area {
        padding: 0.75rem;
      }

      .suggestions {
        gap: 0.25rem;
      }

      .suggestion-chip {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .header-right {
        gap: 0.5rem;
      }

      .message {
        max-width: 95%;
        padding: 0.75rem 1rem;
      }

      .message-input {
        padding: 0.75rem 2.5rem 0.75rem 0.75rem;
        font-size: 0.9rem;
      }

      .send-btn {
        min-width: 45px;
        min-height: 45px;
        padding: 0.75rem;
      }
    }

    /* No dark theme per design requirements */
  </style>
</head>
<body>
  <!-- Header -->
  <header class="chat-header">
    <div class="header-left">
      <a class="back-btn" href="3 home.html" onclick="goBack(); return false;">
        <i class="fas fa-arrow-left"></i>
      </a>
      <h1 class="header-title">
        <i class="fas fa-robot"></i>
        AI Health Assistant
      </h1>
    </div>
    
    <div class="header-right">
      <button class="voice-toggle" id="voiceToggle" onclick="toggleVoiceInput()">
        <i class="fas fa-microphone"></i>
      </button>
      <button class="voice-toggle" id="speakToggle" onclick="toggleSpeechOutput()">
        <i class="fas fa-volume-up"></i>
      </button>
    </div>
  </header>

  <!-- Chat Container -->
  <div class="chat-container">
    <!-- Chat Messages -->
    <div class="chat-messages" id="chatMessages">
      <!-- Welcome Message -->
      <div class="welcome-message" id="welcomeMessage">
        <div class="welcome-icon">
          <i class="fas fa-stethoscope"></i>
        </div>
        <h2 class="welcome-title">Welcome to AI Health Assistant</h2>
        <p class="welcome-text">
          I'm here to help you with health-related questions, natural remedies, and wellness tips. 
          Ask me about symptoms, treatments, or general health advice!
        </p>
      </div>
    </div>

    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <!-- Quick Suggestions -->
    <div class="suggestions-container" id="suggestionsContainer">
      <div class="suggestions-title">Quick suggestions:</div>
      <div class="suggestions" id="suggestions">
        <!-- Suggestions will be populated by JavaScript -->
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-container">
        <textarea 
          class="message-input" 
          id="messageInput" 
          placeholder="Ask me about your health concerns..."
          rows="1"
        ></textarea>
        <div class="input-actions">
          <button class="input-btn" onclick="clearChat()" title="Clear Chat">
            <i class="fas fa-trash"></i>
          </button>
          <button class="input-btn" onclick="toggleHistory()" title="Chat History">
            <i class="fas fa-history"></i>
          </button>
        </div>
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <script src="api-config.js"></script>
  <script>
    // Ripple effect for buttons
    document.addEventListener('click', function(e) {
      const target = e.target.closest('.send-btn, .input-btn, .back-btn, .voice-toggle');
      if (!target) return;
      const ripple = document.createElement('span');
      const rect = target.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      ripple.style.position = 'absolute';
      ripple.style.width = ripple.style.height = size + 'px';
      ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
      ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
      ripple.style.background = 'rgba(255,255,255,0.4)';
      ripple.style.borderRadius = '50%';
      ripple.style.pointerEvents = 'none';
      ripple.style.transform = 'scale(0)';
      ripple.style.transition = 'transform 400ms ease, opacity 600ms ease';
      ripple.className = 'ripple';
      target.style.position = 'relative';
      target.appendChild(ripple);
      requestAnimationFrame(() => {
        ripple.style.transform = 'scale(2)';
        ripple.style.opacity = '0';
      });
      setTimeout(() => ripple.remove(), 650);
    });
    // Global variables
    let currentUser = null;
    let chatHistory = [];
    let isListening = false;
    let speechSynthesis = null;
    let recognition = null;
    let speechEnabled = true;

    // Load expanded data
    async function loadExpandedData() {
      try {
        // Load first aid data
        const firstAidResponse = await fetch('./assets/first_aid_data.json');
        if (firstAidResponse.ok) {
          const firstAidData = await firstAidResponse.json();
          localStorage.setItem('firstAidData', JSON.stringify(firstAidData));
        }
        
        // Load symptoms data
        const symptomsResponse = await fetch('./assets/symptoms_data.json');
        if (symptomsResponse.ok) {
          const symptomsData = await symptomsResponse.json();
          localStorage.setItem('symptomsData', JSON.stringify(symptomsData));
        }
        
        // Load remedies data
        const remediesResponse = await fetch('./assets/remedies_data.json');
        if (remediesResponse.ok) {
          const remediesData = await remediesResponse.json();
          localStorage.setItem('remediesData', JSON.stringify(remediesData));
        }
      } catch (error) {
        console.log('Using cached data for offline mode');
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadExpandedData();
      initializeUser();
      initializeSpeech();
      initializeChat();
      loadSuggestions();
      setupEventListeners();
    });

    // User initialization
    function initializeUser() {
      currentUser = localStorage.getItem('loggedInUser') || 'anonymous';
    }

    // Initialize speech recognition and synthesis
    function initializeSpeech() {
      // Speech Recognition
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
          isListening = true;
          updateVoiceToggle();
        };

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('messageInput').value = transcript;
          sendMessage();
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          isListening = false;
          updateVoiceToggle();
        };

        recognition.onend = function() {
          isListening = false;
          updateVoiceToggle();
        };
      }

      // Speech Synthesis
      if ('speechSynthesis' in window) {
        speechSynthesis = window.speechSynthesis;
      }
    }

    // Initialize chat
    function initializeChat() {
      loadChatHistory();
    }

    // Load chat history
    async function loadChatHistory() {
      try {
        const data = await apiCall(`/chat/history?userId=${currentUser}&limit=20`);
        if (data.success && data.data.length > 0) {
          chatHistory = data.data;
          renderChatHistory();
          hideWelcomeMessage();
        } else {
          // Offline/local fallback
          const local = JSON.parse(localStorage.getItem('chatHistory') || '[]');
          if (local.length > 0) {
            chatHistory = local;
            renderChatHistory();
            hideWelcomeMessage();
          }
        }
      } catch (error) {
        console.error('Error loading chat history:', error);
        const local = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        if (local.length > 0) {
          chatHistory = local;
          renderChatHistory();
          hideWelcomeMessage();
        }
      }
    }

    // Render chat history
    function renderChatHistory() {
      const messagesContainer = document.getElementById('chatMessages');
      const welcomeMessage = document.getElementById('welcomeMessage');
      
      // Remove welcome message if there's chat history
      if (chatHistory.length > 0) {
        welcomeMessage.style.display = 'none';
      }

      // Clear existing messages (except welcome)
      const existingMessages = messagesContainer.querySelectorAll('.message');
      existingMessages.forEach(msg => msg.remove());

      // Render chat history
      chatHistory.forEach(entry => {
        addMessageToChat(entry.user_message, 'user', entry.timestamp);
        addMessageToChat(entry.bot_response, 'bot', entry.timestamp);
      });

      scrollToBottom();
    }

    // Load quick suggestions
    async function loadSuggestions() {
      try {
        const data = await apiCall('/chat/suggestions');
        if (data.success) {
          const suggestionsContainer = document.getElementById('suggestions');
          suggestionsContainer.innerHTML = data.data.slice(0, 6).map(suggestion => 
            `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.keyword}')">
              ${suggestion.keyword}
            </div>`
          ).join('');
        } else {
          // Fallback to static suggestions
          const suggestions = [
            { keyword: 'First aid for burns' },
            { keyword: 'Symptoms of fever' },
            { keyword: 'Home remedy for cough' },
            { keyword: 'When to seek help for chest pain' },
            { keyword: 'Nosebleed first aid' },
            { keyword: 'Headache remedies' }
          ];
          const suggestionsContainer = document.getElementById('suggestions');
          suggestionsContainer.innerHTML = suggestions.map(suggestion => 
            `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.keyword}')">
              ${suggestion.keyword}
            </div>`
          ).join('');
        }
      } catch (error) {
        console.error('Error loading suggestions:', error);
        const suggestions = [
          { keyword: 'First aid for burns' },
          { keyword: 'Symptoms of fever' },
          { keyword: 'Home remedy for cough' },
          { keyword: 'When to seek help for chest pain' },
          { keyword: 'Nosebleed first aid' },
          { keyword: 'Headache remedies' }
        ];
        const suggestionsContainer = document.getElementById('suggestions');
        suggestionsContainer.innerHTML = suggestions.map(suggestion => 
          `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.keyword}')">
            ${suggestion.keyword}
          </div>`
        ).join('');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      // Auto-resize textarea
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // Send message on Enter (but not Shift+Enter)
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Ensure click triggers send even if inline handler is blocked
      sendBtn.addEventListener('click', sendMessage);
    }

    // Send message
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      
      if (!message) return;

      // Add user message to chat
      addMessageToChat(message, 'user');
      
      // Clear input
      messageInput.value = '';
      messageInput.style.height = 'auto';
      document.getElementById('sendBtn').disabled = true;
      
      // Hide welcome message
      hideWelcomeMessage();
      
      // Show typing indicator
      showTypingIndicator();

      try {
        // Send message to backend
        const data = await apiCall('/chat/send', {
          method: 'POST',
          body: JSON.stringify({
            message: message,
            userId: currentUser
          })
        });
        
        // Hide typing indicator
        hideTypingIndicator();

        if (data.success) {
          // Support both snake_case and camelCase from backend
          const botText = data.data.bot_response || data.data.botResponse || '';
          // Add bot response to chat
          addMessageToChat(botText, 'bot');
          
          // Update chat history
          chatHistory.push(data.data);
          
          // Speak the response if speech is enabled
          if (speechEnabled && speechSynthesis) {
            speakText(botText);
          }
          document.getElementById('sendBtn').disabled = false;
        } else {
          addMessageToChat('Sorry, I encountered an error. Please try again.', 'bot');
          document.getElementById('sendBtn').disabled = false;
        }
      } catch (error) {
        console.error('Error sending message:', error);
        hideTypingIndicator();
        addMessageToChat("Connection issue detected. Showing offline guidance.", 'bot');
        // Offline fallback AI response
        const fallback = offlineAIResponse(message);
        addMessageToChat(fallback, 'bot');
        document.getElementById('sendBtn').disabled = false;
      }
    }

    const wellnessGuides = [
      {
        keywords: ['diet', 'nutrition', 'food', 'eat', 'meal'],
        response: 'Balanced nutrition supports healing. Build plates with half colorful vegetables, a quarter lean protein, and a quarter whole grains. Add healthy fats (olive oil, nuts), stay hydrated, and limit ultra-processed snacks.'
      },
      {
        keywords: ['exercise', 'fitness', 'workout', 'stretch'],
        response: 'Aim for 150 minutes of moderate movement weekly. Combine brisk walks, light strength training, and mobility stretches. Warm up, listen to your body, and rest sore muscles to prevent injury.'
      },
      {
        keywords: ['mental', 'mood', 'depress', 'focus', 'mind'],
        response: 'For emotional wellness, pause for deep breathing, name your feelings, and reach out to supportive people. Short gratitude lists or journaling can calm racing thoughts. Seek professional help if mood changes persist.'
      },
      {
        keywords: ['immune', 'immunity'],
        response: 'Support immunity with regular sleep, nutrient-dense meals, joyful movement, hydration, and stress breaks. Handwashing and updated vaccinations remain essential for prevention.'
      },
      {
        keywords: ['hydration', 'water', 'drink'],
        response: 'Sip water steadily through the day. Flavor with citrus, cucumber, or mint. Combine fluids with electrolytes after workouts, illness, or hot weather to avoid cramps and dizziness.'
      },
      {
        keywords: ['skin care', 'skincare', 'glow'],
        response: 'Keep skincare gentle: cleanse with lukewarm water, moisturize damp skin, and apply SPF 30+ daily. Drink water and eat antioxidant-rich foods for a natural glow.'
      }
    ];

    function offlineAIResponse(userMessage) {
      const msg = userMessage.toLowerCase();
      
      // Load expanded data
      const firstAidData = JSON.parse(localStorage.getItem('firstAidData') || '[]');
      const symptomsData = JSON.parse(localStorage.getItem('symptomsData') || '[]');
      const remediesData = JSON.parse(localStorage.getItem('remediesData') || '[]');
      
      const pickBest = (items, getKeywords) => {
        const matches = items.filter(i => (getKeywords(i) || []).some(keyword => msg.includes(String(keyword).toLowerCase())));
        if (matches.length === 0) return null;
        // Prefer verified entries
        matches.sort((a, b) => (b.verified === true) - (a.verified === true));
        return matches[0];
      };
      
      const formatSources = (sources) => {
        if (!sources || sources.length === 0) return '';
        const list = sources.map(s => `${s.name}`).join(', ');
        return `\n\nSources: ${list}`;
      };
      
      // Check for first aid queries
      const fa = pickBest(firstAidData, (i) => i.keywords);
      if (fa) {
        return `For ${fa.title.toLowerCase()}, here's what you should do:\n\n${(fa.steps || []).map((step, index) => `${index + 1}. ${step}`).join('\n')}\n\n‚ö†Ô∏è ${(fa.warnings || []).join(' ')}${formatSources(fa.sources)}\n\nThis is general guidance. For serious emergencies, call emergency services immediately.`;
      }
      
      // Check for symptom queries
      const sym = pickBest(symptomsData, (i) => i.keywords);
      if (sym) {
        return `I understand you're experiencing ${String(sym.name).toLowerCase()}. Here's some helpful information:\n\n**Common causes:** ${(sym.common_causes || []).join(', ')}\n\n**Home remedies:** ${(sym.home_remedies || []).join(', ')}\n\n**When to seek help:** ${sym.when_to_seek_help}${formatSources(sym.sources)}\n\nRemember, I'm here to provide general guidance. If symptoms are severe or persistent, please consult a healthcare professional.`;
      }
      
      // Check for remedy queries
      const rem = pickBest(remediesData, (i) => i.keywords);
      if (rem) {
        const preparation = rem.preparation || (Array.isArray(rem.instructions) ? rem.instructions.join('. ') : 'Follow the listed steps carefully.');
        return `Great question about ${rem.name}! Here's how to prepare it:\n\n**Ingredients:** ${(rem.ingredients || []).join(', ')}\n\n**Preparation:** ${preparation}\n\n**Benefits:** ${(rem.benefits || []).join(', ')}\n\n**Dosage:** ${rem.dosage || 'Use as directed once or twice daily'}\n\n‚ö†Ô∏è **Warnings:** ${(rem.warnings || []).join(' ')}\n\nThis remedy can help with: ${(rem.conditions || []).join(', ')}.${formatSources(rem.sources)}`;
      }

      for (const guide of wellnessGuides) {
        if ((guide.keywords || []).some(keyword => msg.includes(keyword))) {
          return `${guide.response}\n\nLet me know if you‚Äôd like specific recipes, stretches, or habit trackers.`;
        }
      }
      
      // General conversational responses
      if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey')) {
        return 'Hello! I\'m your AI health assistant. I can help you with first aid guidance, symptom information, and natural remedies. What would you like to know about today?';
      }
      
      if (msg.includes('help') || msg.includes('what can you do')) {
        return 'I can help you with:\n\nüè• **First Aid:** Emergency care guidance for injuries and medical emergencies\n\nü§í **Symptoms:** Information about common symptoms and when to seek help\n\nüåø **Remedies:** Natural home remedies and their preparation\n\nüí° **General Health:** Wellness tips and health advice\n\nJust ask me about any health concern you have!';
      }
      
      if (msg.includes('thank') || msg.includes('thanks')) {
        return 'You\'re very welcome! I\'m here whenever you need health guidance. Feel free to ask me anything about first aid, symptoms, or natural remedies.';
      }
      
      if (msg.includes('how are you') || msg.includes('how do you feel')) {
        return 'I\'m doing well, thank you for asking! I\'m here and ready to help with any health questions you might have. How can I assist you today?';
      }
      
      // Default response with suggestions
      return 'I\'m here to help with your health questions! You can ask me about:\n\n‚Ä¢ First aid for injuries or emergencies\n‚Ä¢ Information about symptoms you\'re experiencing\n‚Ä¢ Natural remedies for common conditions\n‚Ä¢ Wellness topics like sleep, hydration, or stress relief\n\nWhat would you like to explore? (Offline mode)';
    }

    // Send suggestion
    function sendSuggestion(keyword) {
      document.getElementById('messageInput').value = keyword;
      sendMessage();
    }

    // Add message to chat
    function addMessageToChat(content, sender, timestamp = null) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const time = timestamp ? new Date(timestamp) : new Date();
      const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-content">${formatMessage(content)}</div>
        <div class="message-time">${timeString}</div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // Format message content
    function formatMessage(content) {
      // Convert line breaks to HTML
      content = content.replace(/\n/g, '<br>');
      
      // Make bold text
      content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      // Make italic text
      content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
      
      return content;
    }

    // Show typing indicator
    function showTypingIndicator() {
      document.getElementById('typingIndicator').classList.add('show');
      scrollToBottom();
    }

    // Hide typing indicator
    function hideTypingIndicator() {
      document.getElementById('typingIndicator').classList.remove('show');
    }

    // Hide welcome message
    function hideWelcomeMessage() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
      }
    }

    // Scroll to bottom
    function scrollToBottom() {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Voice input toggle
    function toggleVoiceInput() {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser.');
        return;
      }

      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }

    // Update voice toggle button
    function updateVoiceToggle() {
      const voiceToggle = document.getElementById('voiceToggle');
      const icon = voiceToggle.querySelector('i');
      
      if (isListening) {
        voiceToggle.classList.add('active');
        icon.className = 'fas fa-stop';
      } else {
        voiceToggle.classList.remove('active');
        icon.className = 'fas fa-microphone';
      }
    }

    // Speech output toggle
    function toggleSpeechOutput() {
      speechEnabled = !speechEnabled;
      const speakToggle = document.getElementById('speakToggle');
      const icon = speakToggle.querySelector('i');
      
      if (speechEnabled) {
        speakToggle.style.background = 'rgba(255,255,255,0.9)';
        speakToggle.style.color = 'var(--secondary-color)';
        icon.className = 'fas fa-volume-up';
      } else {
        speakToggle.style.background = 'rgba(255,255,255,0.2)';
        speakToggle.style.color = 'white';
        icon.className = 'fas fa-volume-mute';
      }
    }

    // Speak text
    function speakText(text) {
      if (!speechSynthesis || !speechEnabled) return;

      // Cancel any ongoing speech
      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.9;
      utterance.pitch = 1;
      utterance.volume = 0.8;

      speechSynthesis.speak(utterance);
    }

    // Clear chat
    async function clearChat() {
      if (confirm('Are you sure you want to clear all chat history?')) {
        try {
          const response = await fetch('/api/chat/history', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: currentUser
            })
          });

          if (response.ok) {
            // Clear local chat history
            chatHistory = [];
            
            // Clear chat display
            const messagesContainer = document.getElementById('chatMessages');
            const existingMessages = messagesContainer.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Show welcome message
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
              welcomeMessage.style.display = 'block';
            }
          }
        } catch (error) {
          console.error('Error clearing chat:', error);
          alert('Failed to clear chat history. Please try again.');
        }
      }
    }

    // Toggle history (placeholder for future implementation)
    function toggleHistory() {
      alert('Chat history feature coming soon!');
    }

    // Navigation
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else if (document.referrer) {
        window.location.href = document.referrer;
      } else {
        window.location.href = '3 home.html';
      }
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && speechSynthesis) {
        speechSynthesis.cancel();
      }
    });
  </script>
</body>
</html>

