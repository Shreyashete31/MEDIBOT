<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Health Assistant - HealthHub</title>
  <meta name="description" content="Chat with our AI health assistant for personalized health advice and remedies">
  <meta name="theme-color" content="#009688">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealthHub Chat">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4a72e0;
      --primary-dark: #355fd0;
      --secondary-color: #5fbfa3;
      --accent-color: #e47f93;
      --text-primary: #1f2a37;
      --text-secondary: #5c6b7a;
      --background: #e2e8ff;
      --surface: #ffffff;
      --border-color: #cbd6e8;
      --shadow: 0 12px 30px rgba(74, 114, 224, 0.18);
      --shadow-hover: 0 18px 40px rgba(53, 95, 208, 0.25);
      --gradient-primary: linear-gradient(135deg, #96b5ff 0%, #dea2ff 100%);
      --bot-color: #d9e8ff;
      --user-color: #4a72e0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #dbe4ff 0%, #ffd2ec 100%);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .chat-header {
      background: var(--gradient-primary);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-hover);
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .voice-toggle {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .voice-toggle:hover {
      background: rgba(255,255,255,0.3);
    }

    .voice-toggle.active {
      background: rgba(255,255,255,0.9);
      color: var(--accent-color);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Chat Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      max-width: 80%;
      padding: 1rem 1.5rem;
      border-radius: 18px;
      position: relative;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: var(--user-color);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }

    .message.bot {
      background: var(--bot-color);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 6px;
    }

    .message-content {
      margin: 0;
      line-height: 1.5;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.5rem;
    }

    .message.user .message-time {
      text-align: right;
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      background: var(--bot-color);
      padding: 1rem 1.5rem;
      border-radius: 18px;
      border-bottom-left-radius: 6px;
      max-width: 80px;
    }

    .typing-indicator.show {
      display: block;
      animation: typingPulse 1.5s infinite;
    }

    @keyframes typingPulse {
      0%, 60%, 100% { opacity: 1; }
      30% { opacity: 0.5; }
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typingDot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingDot {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    /* Quick Suggestions */
    .suggestions-container {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      background: var(--surface);
    }

    .suggestions-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 0.5rem;
      font-weight: 500;
    }

    .suggestions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .suggestion-chip {
      background: var(--background);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .suggestion-chip:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    /* Input Area */
    .input-area {
      padding: 1rem;
      background: var(--surface);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .input-container {
      flex: 1;
      position: relative;
    }

    .message-input {
      width: 100%;
      padding: 1rem 3rem 1rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 25px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s ease;
      resize: none;
      min-height: 50px;
      max-height: 120px;
    }

    .message-input:focus {
      border-color: var(--primary-color);
    }

    .input-actions {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 0.25rem;
    }

    .input-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .input-btn:hover {
      background: var(--background);
      color: var(--primary-color);
    }

    .send-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      min-width: 50px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Welcome Message */
    .welcome-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }

    .welcome-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 0.5rem;
      color: var(--text-primary);
    }

    .welcome-text {
      margin: 0 0 1.5rem;
      line-height: 1.5;
    }

    /* Empty State */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .chat-header {
        padding: 1rem;
      }

      .header-title {
        font-size: 1.2rem;
      }

      .message {
        max-width: 90%;
      }

      .input-area {
        padding: 0.75rem;
      }

      .suggestions {
        gap: 0.25rem;
      }

      .suggestion-chip {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .header-right {
        gap: 0.5rem;
      }

      .message {
        max-width: 95%;
        padding: 0.75rem 1rem;
      }

      .message-input {
        padding: 0.75rem 2.5rem 0.75rem 0.75rem;
        font-size: 0.9rem;
      }

      .send-btn {
        min-width: 45px;
        min-height: 45px;
        padding: 0.75rem;
      }
    }

    /* History Modal */
    .history-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .history-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .history-modal-content {
      background: var(--surface);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      animation: modalSlide 0.3s ease-out;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .history-modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-modal-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
    }

    .history-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.5rem;
      border-radius: 50%;
      transition: background 0.3s ease;
    }

    .history-modal-close:hover {
      background: var(--border-color);
    }

    .history-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .history-item {
      background: var(--background);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .history-item:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--primary-color);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .history-item-preview {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .history-item:hover .history-item-preview {
      color: rgba(255,255,255,0.9);
    }

    .history-item-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .history-item:hover .history-item-time {
      color: rgba(255,255,255,0.8);
    }

    .history-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .history-empty i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* No dark theme per design requirements */
  </style>
</head>
<body>
  <!-- Header -->
  <header class="chat-header">
    <div class="header-left">
      <a class="back-btn" href="3 home.html" onclick="goBack(); return false;">
        <i class="fas fa-arrow-left"></i>
      </a>
      <h1 class="header-title">
        <i class="fas fa-robot"></i>
        AI Health Assistant
      </h1>
    </div>
    
    <div class="header-right">
      <button class="voice-toggle" id="voiceToggle" onclick="toggleVoiceInput()">
        <i class="fas fa-microphone"></i>
      </button>
      <button class="voice-toggle" id="speakToggle" onclick="toggleSpeechOutput()">
        <i class="fas fa-volume-up"></i>
      </button>
    </div>
  </header>

  <!-- Chat Container -->
  <div class="chat-container">
    <!-- Chat Messages -->
    <div class="chat-messages" id="chatMessages">
      <!-- Welcome Message -->
      <div class="welcome-message" id="welcomeMessage">
        <div class="welcome-icon">
          <i class="fas fa-stethoscope"></i>
        </div>
        <h2 class="welcome-title">Welcome to AI Health Assistant</h2>
        <p class="welcome-text">
          I'm here to help you with health-related questions, natural remedies, and wellness tips. 
          Ask me about symptoms, treatments, or general health advice!
        </p>
      </div>
    </div>

    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <!-- Quick Suggestions -->
    <div class="suggestions-container" id="suggestionsContainer">
      <div class="suggestions-title">Quick suggestions:</div>
      <div class="suggestions" id="suggestions">
        <!-- Suggestions will be populated by JavaScript -->
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-container">
        <textarea 
          class="message-input" 
          id="messageInput" 
          placeholder="Ask me about your health concerns..."
          rows="1"
        ></textarea>
        <div class="input-actions">
          <button class="input-btn" onclick="clearChat()" title="Clear Chat">
            <i class="fas fa-trash"></i>
          </button>
          <button class="input-btn" onclick="toggleHistory()" title="Chat History">
            <i class="fas fa-history"></i>
          </button>
        </div>
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- History Modal -->
  <div class="history-modal" id="historyModal">
    <div class="history-modal-content">
      <div class="history-modal-header">
        <h2 class="history-modal-title">
          <i class="fas fa-history"></i> Chat History
        </h2>
        <button class="history-modal-close" onclick="closeHistoryModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="history-modal-body" id="historyModalBody">
        <!-- History items will be populated here -->
      </div>
    </div>
  </div>

  <script src="api-config.js"></script>
  <script>
    // Ripple effect for buttons
    document.addEventListener('click', function(e) {
      const target = e.target.closest('.send-btn, .input-btn, .back-btn, .voice-toggle');
      if (!target) return;
      const ripple = document.createElement('span');
      const rect = target.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      ripple.style.position = 'absolute';
      ripple.style.width = ripple.style.height = size + 'px';
      ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
      ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
      ripple.style.background = 'rgba(255,255,255,0.4)';
      ripple.style.borderRadius = '50%';
      ripple.style.pointerEvents = 'none';
      ripple.style.transform = 'scale(0)';
      ripple.style.transition = 'transform 400ms ease, opacity 600ms ease';
      ripple.className = 'ripple';
      target.style.position = 'relative';
      target.appendChild(ripple);
      requestAnimationFrame(() => {
        ripple.style.transform = 'scale(2)';
        ripple.style.opacity = '0';
      });
      setTimeout(() => ripple.remove(), 650);
    });
    // Global variables
    let currentUser = null;
    let chatHistory = [];
    let isListening = false;
    let speechSynthesis = null;
    let recognition = null;
    let speechEnabled = true;

    // Load expanded data
    async function loadExpandedData() {
      try {
        // Load first aid data
        const firstAidResponse = await fetch('./assets/first_aid_data.json');
        if (firstAidResponse.ok) {
          const firstAidData = await firstAidResponse.json();
          localStorage.setItem('firstAidData', JSON.stringify(firstAidData));
        }
        
        // Load symptoms data
        const symptomsResponse = await fetch('./assets/symptoms_data.json');
        if (symptomsResponse.ok) {
          const symptomsData = await symptomsResponse.json();
          localStorage.setItem('symptomsData', JSON.stringify(symptomsData));
        }
        
        // Load remedies data
        const remediesResponse = await fetch('./assets/remedies_data.json');
        if (remediesResponse.ok) {
          const remediesData = await remediesResponse.json();
          localStorage.setItem('remediesData', JSON.stringify(remediesData));
        }
      } catch (error) {
        console.log('Using cached data for offline mode');
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadExpandedData();
      initializeUser();
      initializeSpeech();
      initializeChat();
      loadSuggestions();
      setupEventListeners();
    });

    // User initialization
    function initializeUser() {
      currentUser = localStorage.getItem('loggedInUser') || 'anonymous';
    }

    // Initialize speech recognition and synthesis
    function initializeSpeech() {
      // Speech Recognition
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
          isListening = true;
          updateVoiceToggle();
        };

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('messageInput').value = transcript;
          sendMessage();
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          isListening = false;
          updateVoiceToggle();
        };

        recognition.onend = function() {
          isListening = false;
          updateVoiceToggle();
        };
      }

      // Speech Synthesis
      if ('speechSynthesis' in window) {
        speechSynthesis = window.speechSynthesis;
      }
    }

    // Initialize chat
    function initializeChat() {
      loadChatHistory();
    }

    // Load chat history
    async function loadChatHistory() {
      try {
        const data = await apiCall(`/chat/history?userId=${currentUser}&limit=20`);
        if (data.success && data.data.length > 0) {
          chatHistory = data.data;
          renderChatHistory();
          hideWelcomeMessage();
        } else {
          // Offline/local fallback
          const local = JSON.parse(localStorage.getItem('chatHistory') || '[]');
          if (local.length > 0) {
            chatHistory = local;
            renderChatHistory();
            hideWelcomeMessage();
          }
        }
      } catch (error) {
        console.error('Error loading chat history:', error);
        const local = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        if (local.length > 0) {
          chatHistory = local;
          renderChatHistory();
          hideWelcomeMessage();
        }
      }
    }

    // Render chat history
    function renderChatHistory() {
      const messagesContainer = document.getElementById('chatMessages');
      const welcomeMessage = document.getElementById('welcomeMessage');
      
      // Remove welcome message if there's chat history
      if (chatHistory.length > 0) {
        welcomeMessage.style.display = 'none';
      }

      // Clear existing messages (except welcome)
      const existingMessages = messagesContainer.querySelectorAll('.message');
      existingMessages.forEach(msg => msg.remove());

      // Render chat history
      chatHistory.forEach(entry => {
        addMessageToChat(entry.user_message, 'user', entry.timestamp);
        addMessageToChat(entry.bot_response, 'bot', entry.timestamp);
      });

      scrollToBottom();
    }

    // Load quick suggestions
    async function loadSuggestions() {
      try {
        const data = await apiCall('/chat/suggestions');
        if (data.success) {
          const suggestionsContainer = document.getElementById('suggestions');
          suggestionsContainer.innerHTML = data.data.slice(0, 6).map(suggestion => 
            `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.keyword}')">
              ${suggestion.keyword}
            </div>`
          ).join('');
        } else {
          // Fallback to static suggestions
          const suggestions = [
            { keyword: 'First aid for burns' },
            { keyword: 'Symptoms of fever' },
            { keyword: 'Home remedy for cough' },
            { keyword: 'When to seek help for chest pain' },
            { keyword: 'Nosebleed first aid' },
            { keyword: 'Headache remedies' }
          ];
          const suggestionsContainer = document.getElementById('suggestions');
          suggestionsContainer.innerHTML = suggestions.map(suggestion => 
            `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.keyword}')">
              ${suggestion.keyword}
            </div>`
          ).join('');
        }
      } catch (error) {
        console.error('Error loading suggestions:', error);
        const suggestions = [
          { keyword: 'First aid for burns' },
          { keyword: 'Symptoms of fever' },
          { keyword: 'Home remedy for cough' },
          { keyword: 'When to seek help for chest pain' },
          { keyword: 'Nosebleed first aid' },
          { keyword: 'Headache remedies' }
        ];
        const suggestionsContainer = document.getElementById('suggestions');
        suggestionsContainer.innerHTML = suggestions.map(suggestion => 
          `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.keyword}')">
            ${suggestion.keyword}
          </div>`
        ).join('');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      // Auto-resize textarea
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // Send message on Enter (but not Shift+Enter)
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Ensure click triggers send even if inline handler is blocked
      sendBtn.addEventListener('click', sendMessage);
    }

    // Send message
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      
      if (!message) return;

      // Add user message to chat
      addMessageToChat(message, 'user');
      
      // Clear input
      messageInput.value = '';
      messageInput.style.height = 'auto';
      document.getElementById('sendBtn').disabled = true;
      
      // Hide welcome message
      hideWelcomeMessage();
      
      // Show typing indicator
      showTypingIndicator();

      let botResponse = '';
      const timestamp = new Date().toISOString();

      try {
        // Send message to backend
        const data = await apiCall('/chat/send', {
          method: 'POST',
          body: JSON.stringify({
            message: message,
            userId: currentUser
          })
        });
        
        // Hide typing indicator
        hideTypingIndicator();

        if (data.success) {
          // Support both snake_case and camelCase from backend
          botResponse = data.data.bot_response || data.data.botResponse || '';
          // Add bot response to chat
          addMessageToChat(botResponse, 'bot');
          
          // Update chat history
          const chatEntry = {
            user_message: message,
            bot_response: botResponse,
            timestamp: data.data.timestamp || data.data.created_at || timestamp,
            userId: currentUser
          };
          chatHistory.push(chatEntry);
          
          // Save to localStorage
          saveChatHistoryToLocal();
          
          // Speak the response if speech is enabled
          if (speechEnabled && speechSynthesis) {
            speakText(botResponse);
          }
          document.getElementById('sendBtn').disabled = false;
        } else {
          botResponse = 'Sorry, I encountered an error. Please try again.';
          addMessageToChat(botResponse, 'bot');
          
          // Save even error messages to history
          const chatEntry = {
            user_message: message,
            bot_response: botResponse,
            timestamp: timestamp,
            userId: currentUser
          };
          chatHistory.push(chatEntry);
          saveChatHistoryToLocal();
          
          document.getElementById('sendBtn').disabled = false;
        }
      } catch (error) {
        console.error('Error sending message:', error);
        hideTypingIndicator();
        addMessageToChat("Connection issue detected. Showing offline guidance.", 'bot');
        // Offline fallback AI response
        botResponse = offlineAIResponse(message);
        addMessageToChat(botResponse, 'bot');
        
        // Save offline conversation to history
        const chatEntry = {
          user_message: message,
          bot_response: botResponse,
          timestamp: timestamp,
          userId: currentUser
        };
        chatHistory.push(chatEntry);
        saveChatHistoryToLocal();
                                        
        document.getElementById('sendBtn').disabled = false;
      }
    }

    const wellnessGuides = [
      {
        keywords: ['diet', 'nutrition', 'food', 'eat', 'meal'],
        response: 'Balanced nutrition supports healing. Build plates with half colorful vegetables, a quarter lean protein, and a quarter whole grains. Add healthy fats (olive oil, nuts), stay hydrated, and limit ultra-processed snacks.'
      },
      {
        keywords: ['exercise', 'fitness', 'workout', 'stretch'],
        response: 'Aim for 150 minutes of moderate movement weekly. Combine brisk walks, light strength training, and mobility stretches. Warm up, listen to your body, and rest sore muscles to prevent injury.'
      },
      {
        keywords: ['mental', 'mood', 'depress', 'focus', 'mind'],
        response: 'For emotional wellness, pause for deep breathing, name your feelings, and reach out to supportive people. Short gratitude lists or journaling can calm racing thoughts. Seek professional help if mood changes persist.'
      },
      {
        keywords: ['immune', 'immunity'],
        response: 'Support immunity with regular sleep, nutrient-dense meals, joyful movement, hydration, and stress breaks. Handwashing and updated vaccinations remain essential for prevention.'
      },
      {
        keywords: ['hydration', 'water', 'drink'],
        response: 'Sip water steadily through the day. Flavor with citrus, cucumber, or mint. Combine fluids with electrolytes after workouts, illness, or hot weather to avoid cramps and dizziness.'
      },
      {
        keywords: ['skin care', 'skincare', 'glow'],
        response: 'Keep skincare gentle: cleanse with lukewarm water, moisturize damp skin, and apply SPF 30+ daily. Drink water and eat antioxidant-rich foods for a natural glow.'
      }
    ];

    function offlineAIResponse(userMessage) {
      var msg = String(userMessage || '').toLowerCase();
      var firstAidData = JSON.parse(localStorage.getItem('firstAidData') || '[]');
      var symptomsData = JSON.parse(localStorage.getItem('symptomsData') || '[]');
      var remediesData = JSON.parse(localStorage.getItem('remediesData') || '[]');

      function anyContains(text, arr) {
        var t = String(text || '').toLowerCase();
        for (var i = 0; i < arr.length; i++) { if (t.indexOf(arr[i]) !== -1) return true; }
        return false;
      }

      function formatList(arr) {
        return (arr || []).join(', ');
      }

      function pickBest(items, getKeywords) {
        var matches = items.filter(function(i){
          var kws = (getKeywords(i) || []).map(function(k){ return String(k).toLowerCase(); });
          for (var j = 0; j < kws.length; j++) { if (msg.indexOf(kws[j]) !== -1) return true; }
          return false;
        });
        if (matches.length === 0) return null;
        matches.sort(function(a,b){ return (b.verified === true) - (a.verified === true); });
        return matches[0];
      }

      function formatSources(sources) {
        if (!sources || sources.length === 0) return '';
        var list = sources.map(function(s){ return s.name; }).join(', ');
        return '\n\nSources: ' + list;
      }

      function suggestRemedies(keys) {
        var out = [];
        for (var i = 0; i < remediesData.length; i++) {
          var r = remediesData[i];
          var pool = [];
          if (Array.isArray(r.keywords)) pool = pool.concat(r.keywords);
          if (Array.isArray(r.conditions)) pool = pool.concat(r.conditions);
          var hit = pool.some(function(k){ return keys.some(function(x){ return String(k).toLowerCase().indexOf(x) !== -1; }); });
          if (hit) out.push(r);
          if (out.length >= 3) break;
        }
        return out;
      }

      function renderRemedyBlock(titleKeys) {
        var rems = suggestRemedies(titleKeys);
        if (!rems || rems.length === 0) return '';
        var names = rems.map(function(r){ return r.name; }).join(', ');
        return '\n\nYou can try these natural remedies: ' + names + '. Always check allergies and interactions.';
      }

      var nonHealth = ['movie','music','song','weather','finance','stock','game','code','programming','politics','news','sports','celebrity','travel tip'];
      if (anyContains(msg, nonHealth)) {
        return 'I only guide for healthcare, first aid, symptoms, and natural remedies. Please ask a health-related question.';
      }

      var distress = ['not feeling well','feel sick','unwell','feel bad','not well','feeling weak'];
      if (anyContains(msg, distress)) {
        var triage = '**Let\'s figure this out.** Please share: \n• When it started and how severe it is \n• Fever or chills? \n• Cough, sore throat, headache, stomach issues? \n• Chest pain or breathing difficulty? \n• Recent exposure, travel, new foods/medicines';
        var tips = '\n\nStart with rest, fluids, and light meals. If severe symptoms or chest pain/shortness of breath occur, seek urgent care.';
        return triage + '\n\nTry exploring: Symptoms of fever, Home remedy for cough, Headache remedies.';
      }

      if (anyContains(msg, ['fever','temperature','high temp'])) {
        var block = '**Fever support**\n\n• Hydrate with water and oral rehydration fluids \n• Rest in a cool room; light clothing \n• Lukewarm sponge baths, avoid cold shock \n• Consider antipyretics per label guidance \n• Monitor red flags: very high fever, confusion, stiff neck, breathing difficulty';
        return block + renderRemedyBlock(['fever','temperature']);
      }

      if (anyContains(msg, ['cold','cough','sore throat','runny nose'])) {
        var block2 = '**Cold and cough care**\n\n• Warm fluids and steam inhalation \n• Honey-lemon in warm water (not for infants) \n• Salt-water gargles for sore throat \n• Rest and gentle hydration \n• Seek help for high fever, chest pain, or breathing issues';
        return block2 + renderRemedyBlock(['cold','cough','sore throat']);
      }

      if (anyContains(msg, ['headache','migraine'])) {
        var block3 = '**Headache relief**\n\n• Hydration, dim lights, minimize screen time \n• Gentle neck/shoulder stretches \n• Avoid skipping meals; manage caffeine \n• Track triggers (sleep, stress, foods)';
        return block3 + renderRemedyBlock(['headache','migraine']);
      }

      if (anyContains(msg, ['stomach pain','abdominal pain','gastric','acidity'])) {
        var block4 = '**Stomach discomfort**\n\n• Small bland meals (rice, banana, toast) \n• Hydration; oral rehydration if diarrhea \n• Avoid spicy or fatty foods \n• Seek care for severe pain, blood in stool, persistent vomiting';
        return block4 + renderRemedyBlock(['stomach','acidity','gastric']);
      }

      if (anyContains(msg, ['diarrhea','loose motion','vomit','vomiting','nausea'])) {
        var block5 = '**GI support**\n\n• Oral rehydration, small sips \n• Rest; advance diet slowly \n• Avoid dairy and heavy foods initially \n• Urgent care for signs of dehydration, blood, high fever';
        return block5 + renderRemedyBlock(['diarrhea','vomit','nausea']);
      }

      if (anyContains(msg, ['chest pain','shortness of breath','breathing difficulty'])) {
        var faChest = pickBest(firstAidData, function(i){ return i.keywords; });
        var urgent = '**Urgent attention**\n\nChest pain or breathing difficulty can be serious. Seek emergency care immediately.';
        return urgent;
      }

      var fa = pickBest(firstAidData, function(i){ return i.keywords; });
      if (fa) {
        return 'For ' + String(fa.title || '').toLowerCase() + ', do:\n\n' + (Array.isArray(fa.steps) ? fa.steps.map(function(s,idx){ return (idx+1)+'. '+s; }).join('\n') : '') + '\n\n⚠️ ' + (Array.isArray(fa.warnings) ? fa.warnings.join(' ') : '') + formatSources(fa.sources) + '\n\nCall emergency services for severe cases.';
      }

      var sym = pickBest(symptomsData, function(i){ return i.keywords; });
      if (sym) {
        return 'I understand you\'re experiencing ' + String(sym.name || '').toLowerCase() + '.\n\n**Common causes:** ' + formatList(sym.common_causes || []) + '\n\n**Home remedies:** ' + formatList(sym.home_remedies || []) + '\n\n**When to seek help:** ' + (sym.when_to_seek_help || '') + formatSources(sym.sources) + '\n\nIf symptoms are severe or persistent, consult a healthcare professional.';
      }

      var rem = pickBest(remediesData, function(i){ return i.keywords; });
      if (rem) {
        var prep = rem.preparation || (Array.isArray(rem.instructions) ? rem.instructions.join('. ') : 'Follow the listed steps carefully.');
        return 'About ' + rem.name + ':\n\n**Ingredients:** ' + formatList(rem.ingredients || []) + '\n\n**Preparation:** ' + prep + '\n\n**Benefits:** ' + formatList(rem.benefits || []) + '\n\n**Dosage:** ' + (rem.dosage || 'Use as directed once or twice daily') + '\n\n⚠️ **Warnings:** ' + (Array.isArray(rem.warnings) ? rem.warnings.join(' ') : '') + '\n\nHelps with: ' + formatList(rem.conditions || []) + formatSources(rem.sources);
      }

      for (var g = 0; g < wellnessGuides.length; g++) {
        var guide = wellnessGuides[g];
        var kws = guide.keywords || [];
        for (var k = 0; k < kws.length; k++) {
          if (msg.indexOf(kws[k]) !== -1) {
            return guide.response + '\n\nTell me if you want specific recipes, stretches, or trackers.';
          }
        }
      }

      return 'I guide health topics only. Ask me about first aid, symptoms, or natural remedies. You can start with: Symptoms of fever, Home remedy for cough, Headache remedies.';
    }

    // Send suggestion
    function sendSuggestion(keyword) {
      document.getElementById('messageInput').value = keyword;
      sendMessage();
    }

    // Add message to chat
    function addMessageToChat(content, sender, timestamp = null) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const time = timestamp ? new Date(timestamp) : new Date();
      const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-content">${formatMessage(content)}</div>
        <div class="message-time">${timeString}</div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // Format message content
    function formatMessage(content) {
      // Convert line breaks to HTML
      content = content.replace(/\n/g, '<br>');
      
      // Make bold text
      content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      // Make italic text
      content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
      
      return content;
    }

    // Show typing indicator
    function showTypingIndicator() {
      document.getElementById('typingIndicator').classList.add('show');
      scrollToBottom();
    }

    // Hide typing indicator
    function hideTypingIndicator() {
      document.getElementById('typingIndicator').classList.remove('show');
    }

    // Hide welcome message
    function hideWelcomeMessage() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
      }
    }

    // Scroll to bottom
    function scrollToBottom() {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Voice input toggle
    function toggleVoiceInput() {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser.');
        return;
      }

      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }

    // Update voice toggle button
    function updateVoiceToggle() {
      const voiceToggle = document.getElementById('voiceToggle');
      const icon = voiceToggle.querySelector('i');
      
      if (isListening) {
        voiceToggle.classList.add('active');
        icon.className = 'fas fa-stop';
      } else {
        voiceToggle.classList.remove('active');
        icon.className = 'fas fa-microphone';
      }
    }

    // Speech output toggle
    function toggleSpeechOutput() {
      speechEnabled = !speechEnabled;
      const speakToggle = document.getElementById('speakToggle');
      const icon = speakToggle.querySelector('i');
      
      if (speechEnabled) {
        speakToggle.style.background = 'rgba(255,255,255,0.9)';
        speakToggle.style.color = 'var(--secondary-color)';
        icon.className = 'fas fa-volume-up';
      } else {
        speakToggle.style.background = 'rgba(255,255,255,0.2)';
        speakToggle.style.color = 'white';
        icon.className = 'fas fa-volume-mute';
      }
    }

    // Speak text
    function speakText(text) {
      if (!speechSynthesis || !speechEnabled) return;

      // Cancel any ongoing speech
      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.9;
      utterance.pitch = 1;
      utterance.volume = 0.8;

      speechSynthesis.speak(utterance);
    }

    // Save chat history to localStorage
    function saveChatHistoryToLocal() {
      try {
        // Save the entire chatHistory array
        const toSave = chatHistory.map(entry => ({
          user_message: entry.user_message || entry.message || '',
          bot_response: entry.bot_response || entry.botResponse || '',
          timestamp: entry.timestamp || entry.created_at || new Date().toISOString(),
          userId: entry.userId || currentUser
        }));
        
        // Remove duplicates based on timestamp and message content
        const unique = [];
        const seen = new Set();
        toSave.forEach(entry => {
          const key = `${entry.timestamp}_${entry.user_message}`;
          if (!seen.has(key)) {
            seen.add(key);
            unique.push(entry);
          }
        });
        
        // Sort by timestamp (newest first) and keep only last 100 entries
        unique.sort((a, b) => {
          const timeA = new Date(a.timestamp || 0).getTime();
          const timeB = new Date(b.timestamp || 0).getTime();
          return timeB - timeA;
        });
        
        localStorage.setItem('chatHistory', JSON.stringify(unique.slice(0, 100)));
        console.log('Saved chat history:', unique.length, 'entries');
      } catch (error) {
        console.error('Error saving chat history:', error);
      }
    }

    // Clear chat
    async function clearChat() {
      if (confirm('Are you sure you want to clear all chat history?')) {
        try {
          const response = await fetch('/api/chat/history', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: currentUser
            })
          });

          if (response.ok || true) { // Also clear locally even if API fails
            // Clear local chat history
            chatHistory = [];
            localStorage.setItem('chatHistory', JSON.stringify([]));
            
            // Clear chat display
            const messagesContainer = document.getElementById('chatMessages');
            const existingMessages = messagesContainer.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Show welcome message
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
              welcomeMessage.style.display = 'block';
            }
            
            // Close history modal if open
            closeHistoryModal();
          }
        } catch (error) {
          console.error('Error clearing chat:', error);
          // Clear locally anyway
          chatHistory = [];
          localStorage.setItem('chatHistory', JSON.stringify([]));
          const messagesContainer = document.getElementById('chatMessages');
          const existingMessages = messagesContainer.querySelectorAll('.message');
          existingMessages.forEach(msg => msg.remove());
          const welcomeMessage = document.getElementById('welcomeMessage');
          if (welcomeMessage) {
            welcomeMessage.style.display = 'block';
          }
          closeHistoryModal();
        }
      }
    }

    // Toggle history modal
    function toggleHistory() {
      const modal = document.getElementById('historyModal');
      if (modal.classList.contains('show')) {
        closeHistoryModal();
      } else {
        showHistoryModal();
      }
    }

    // Show history modal
    async function showHistoryModal() {
      const modal = document.getElementById('historyModal');
      const modalBody = document.getElementById('historyModalBody');
      
      // Show loading state
      modalBody.innerHTML = `
        <div class="history-empty">
          <i class="fas fa-spinner fa-spin"></i>
          <h3>Loading History...</h3>
        </div>
      `;
      modal.classList.add('show');
      
      // Load all chat history
      try {
        const history = await loadAllChatHistory();
        console.log('History loaded for modal:', history.length, 'entries');
        
        if (history.length === 0) {
          modalBody.innerHTML = `
            <div class="history-empty">
              <i class="fas fa-inbox"></i>
              <h3>No Chat History</h3>
              <p>Start a conversation to see your chat history here.</p>
            </div>
          `;
        } else {
          // Group history by date
          const grouped = groupHistoryByDate(history);
          modalBody.innerHTML = Object.keys(grouped).map(date => `
            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 0.75rem; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase;">
                ${date}
              </h4>
              ${grouped[date].map((item, index) => {
                const time = new Date(item.timestamp || item.created_at || Date.now());
                const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const preview = (item.user_message || item.message || '').substring(0, 100);
                const uniqueKey = `${item.timestamp || item.created_at}_${index}`;
                return `
                  <div class="history-item" onclick="loadHistoryConversation('${uniqueKey}')">
                    <div class="history-item-header">
                      <div class="history-item-time">${timeString}</div>
                    </div>
                    <p class="history-item-preview">${escapeHtml(preview)}${preview.length >= 100 ? '...' : ''}</p>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading history for modal:', error);
        modalBody.innerHTML = `
          <div class="history-empty">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading History</h3>
            <p>Please try again later.</p>
          </div>
        `;
      }
    }

    // Close history modal
    function closeHistoryModal() {
      const modal = document.getElementById('historyModal');
      modal.classList.remove('show');
    }

    // Load all chat history
    async function loadAllChatHistory() {
      let history = [];
      
      try {
        // Try to load from API first
        const data = await apiCall(`/chat/history?userId=${currentUser}&limit=100`);
        if (data.success && Array.isArray(data.data) && data.data.length > 0) {
          history = data.data;
          // Merge with local storage
          const local = JSON.parse(localStorage.getItem('chatHistory') || '[]');
          history = mergeHistory(history, local);
        }
      } catch (error) {
        console.log('API not available, using local storage');
      }
      
      // Fallback to localStorage if API didn't return data
      if (history.length === 0) {
        try {
          const local = JSON.parse(localStorage.getItem('chatHistory') || '[]');
          history = Array.isArray(local) ? local : [];
          console.log('Loaded from localStorage:', history.length, 'entries');
        } catch (e) {
          console.error('Error loading from localStorage:', e);
          history = [];
        }
      }
      
      return history;
    }

    // Merge API and local history, removing duplicates
    function mergeHistory(apiHistory, localHistory) {
      const merged = [...apiHistory];
      const seen = new Set();
      
      apiHistory.forEach(entry => {
        const key = `${entry.timestamp || entry.created_at}_${entry.user_message || entry.message}`;
        seen.add(key);
      });
      
      localHistory.forEach(entry => {
        const key = `${entry.timestamp || entry.created_at}_${entry.user_message || entry.message}`;
        if (!seen.has(key)) {
          seen.add(key);
          merged.push(entry);
        }
      });
      
      // Sort by timestamp (newest first)
      merged.sort((a, b) => {
        const timeA = new Date(a.timestamp || a.created_at || 0).getTime();
        const timeB = new Date(b.timestamp || b.created_at || 0).getTime();
        return timeB - timeA;
      });
      
      return merged;
    }

    // Group history by date
    function groupHistoryByDate(history) {
      const grouped = {};
      history.forEach(item => {
        const date = new Date(item.timestamp || item.created_at || Date.now());
        const dateKey = date.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        if (!grouped[dateKey]) {
          grouped[dateKey] = [];
        }
        grouped[dateKey].push(item);
      });
      
      // Sort each group by time (newest first)
      Object.keys(grouped).forEach(date => {
        grouped[date].sort((a, b) => {
          const timeA = new Date(a.timestamp || a.created_at || 0);
          const timeB = new Date(b.timestamp || b.created_at || 0);
          return timeB - timeA;
        });
      });
      
      return grouped;
    }

    // Load a specific conversation from history
    async function loadHistoryConversation(uniqueKey) {
      try {
        // Load all history to find the conversation
        const allHistory = await loadAllChatHistory();
        const [timestamp] = uniqueKey.split('_');
        
        // Find conversation by timestamp
        const conversation = allHistory.find(h => 
          (h.timestamp || h.created_at) === timestamp || 
          String(h.timestamp || h.created_at).includes(timestamp)
        );
        
        if (conversation) {
          // Load the conversation into the chat
          chatHistory = [conversation];
          renderChatHistory();
          closeHistoryModal();
          scrollToBottom();
        } else {
          // Try to find in current chatHistory array
          const foundInCurrent = chatHistory.find(h => 
            (h.timestamp || h.created_at) === timestamp ||
            String(h.timestamp || h.created_at).includes(timestamp)
          );
          
          if (foundInCurrent) {
            chatHistory = [foundInCurrent];
            renderChatHistory();
            closeHistoryModal();
            scrollToBottom();
          } else {
            alert('Could not load this conversation. It may have been deleted.');
          }
        }
      } catch (error) {
        console.error('Error loading conversation:', error);
        alert('Error loading conversation. Please try again.');
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('historyModal');
      if (e.target === modal) {
        closeHistoryModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeHistoryModal();
      }
    });

    // Navigation
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else if (document.referrer) {
        window.location.href = document.referrer;
      } else {
        window.location.href = '3 home.html';
      }
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && speechSynthesis) {
        speechSynthesis.cancel();
      }
    });
  </script>
</body>
</html>

