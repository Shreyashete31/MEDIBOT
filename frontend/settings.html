<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Settings - HealthHub</title>
  <meta name="description" content="Customize your HealthHub experience with theme, accessibility, and control settings">
  <meta name="theme-color" content="#009688">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealthHub">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="dark-mode.js"></script>
  <style>
    :root {
      --primary-color: #3fb0e6;
      --primary-dark: #2799d6;
      --secondary-color: #70b977;
      --accent-color: #f07a5a;
      --text-primary: #2c3e50;
      --text-secondary: #5d6d7e;
      --background: #eaf8ff;
      --surface: #ffffff;
      --border-color: #d1e6f0;
      --shadow: 0 2px 12px rgba(63, 176, 230, 0.14);
      --shadow-hover: 0 4px 24px rgba(39, 153, 214, 0.2);
      --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      --gradient-secondary: linear-gradient(135deg, var(--secondary-color), #56a962);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f2ff 0%, #e0fff0 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Header */
    .app-header {
      background: var(--gradient-primary);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-hover);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    /* Main Content */
    .main-content {
      padding: 2rem 1.5rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .settings-section {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 1.5rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title i {
      font-size: 1.25rem;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-info {
      flex: 1;
    }

    .setting-title {
      font-weight: 600;
      margin: 0 0 0.25rem;
      color: var(--text-primary);
    }

    .setting-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .setting-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--primary-color);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(26px);
    }

    .select-control {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      min-width: 120px;
    }

    .select-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
    }

    .range-control {
      width: 150px;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .range-control::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .range-control::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .range-value {
      font-weight: 600;
      color: var(--primary-color);
      min-width: 30px;
      text-align: center;
    }

    .theme-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .theme-option {
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .theme-option:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .theme-option.active {
      border-color: var(--primary-color);
      background: rgba(79, 195, 247, 0.1);
    }

    .theme-preview {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 auto 0.5rem;
    }

    .theme-light .theme-preview {
      background: linear-gradient(135deg, #f0f8ff, #f0fff4);
    }

    .theme-dark .theme-preview {
      background: linear-gradient(135deg, #2c3e50, #34495e);
    }

    .theme-auto .theme-preview {
      background: linear-gradient(135deg, #f0f8ff 50%, #2c3e50 50%);
    }

    .theme-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin: 0;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--background);
    }

    .btn-danger {
      background: #ef5350;
      color: white;
    }

    .btn-danger:hover {
      background: #e53935;
    }

    .notification {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: none;
    }

    .notification.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #4caf50;
    }

    .notification.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }

    /* screen-reader only helper */
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; /* added line to prevent wrapping */
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }
      
      .settings-section {
        padding: 1.5rem;
      }
      
      .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .setting-control {
        width: 100%;
        justify-content: flex-end;
      }
      
      .theme-options {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-left">
      <button class="back-btn" onclick="history.back()" type="button" aria-label="Go back">
        <i class="fas fa-arrow-left" aria-hidden="true"></i>
      </button>
      <h1 class="header-title">Settings</h1>
    </div>
  </header>

  <main class="main-content" role="main">
    <div id="notification" class="notification" role="status" aria-live="polite"></div>

    <!-- Theme Settings -->
    <section class="settings-section">
      <h2 class="section-title">
        <i class="fas fa-palette"></i>
        Theme & Appearance
      </h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Dark Mode</h3>
          <p class="setting-description">Switch between light and dark themes</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch" id="darkModeToggle" role="switch" aria-checked="false" tabindex="0" onclick="toggleDarkMode()" onkeydown="toggleOnKey(event,'darkModeToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Theme Preference</h3>
          <p class="setting-description">Choose your preferred color scheme</p>
        </div>
        <div class="theme-options" id="themeOptions" role="list">
          <div class="theme-option theme-light active" role="button" tabindex="0" aria-pressed="true" data-theme="light" onclick="selectTheme('light')" onkeydown="optionOnKey(event,'light')">
            <div class="theme-preview"></div>
            <p class="theme-name">Light</p>
          </div>
          <div class="theme-option theme-dark" role="button" tabindex="0" aria-pressed="false" data-theme="dark" onclick="selectTheme('dark')" onkeydown="optionOnKey(event,'dark')">
            <div class="theme-preview"></div>
            <p class="theme-name">Dark</p>
          </div>
          <div class="theme-option theme-auto" role="button" tabindex="0" aria-pressed="false" data-theme="auto" onclick="selectTheme('auto')" onkeydown="optionOnKey(event,'auto')">
            <div class="theme-preview"></div>
            <p class="theme-name">Auto</p>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Font Size</h3>
          <p class="setting-description">Adjust text size for better readability</p>
        </div>
        <div class="setting-control">
          <input type="range" class="range-control" id="fontSizeRange" min="12" max="20" value="16" oninput="updateFontSize(this.value)">
          <span class="range-value" id="fontSizeValue">16px</span>
        </div>
      </div>
    </section>

    <!-- Accessibility Settings -->
    <section class="settings-section">
      <h2 class="section-title">
        <i class="fas fa-universal-access"></i>
        Accessibility
      </h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">High Contrast</h3>
          <p class="setting-description">Increase contrast for better visibility</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch" id="highContrastToggle" onclick="toggleHighContrast()" role="switch" aria-checked="false" tabindex="0" onkeydown="toggleOnKey(event,'highContrastToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Voice Navigation</h3>
          <p class="setting-description">Enable voice commands and audio feedback</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch" id="voiceNavToggle" onclick="toggleVoiceNavigation()" role="switch" aria-checked="false" tabindex="0" onkeydown="toggleOnKey(event,'voiceNavToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Screen Reader Support</h3>
          <p class="setting-description">Optimize for screen readers and assistive technologies</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch" id="screenReaderToggle" onclick="toggleScreenReader()" role="switch" aria-checked="false" tabindex="0" onkeydown="toggleOnKey(event,'screenReaderToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Animation Speed</h3>
          <p class="setting-description">Control animation speed for comfort</p>
        </div>
        <div class="setting-control">
          <select class="select-control" id="animationSpeed" onchange="updateAnimationSpeed(this.value)">
            <option value="slow">Slow</option>
            <option value="normal" selected>Normal</option>
            <option value="fast">Fast</option>
            <option value="none">None</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Control Settings -->
    <section class="settings-section">
      <h2 class="section-title">
        <i class="fas fa-cog"></i>
        Controls & Behavior
      </h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Auto-save Progress</h3>
          <p class="setting-description">Automatically save your progress and preferences</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch active" id="autoSaveToggle" onclick="toggleAutoSave()" role="switch" aria-checked="true" tabindex="0" onkeydown="toggleOnKey(event,'autoSaveToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Notifications</h3>
          <p class="setting-description">Receive health tips and reminders</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch active" id="notificationsToggle" onclick="toggleNotifications()" role="switch" aria-checked="true" tabindex="0" onkeydown="toggleOnKey(event,'notificationsToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Offline Mode</h3>
          <p class="setting-description">Enable offline access to all features</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch active" id="offlineToggle" onclick="toggleOfflineMode()" role="switch" aria-checked="true" tabindex="0" onkeydown="toggleOnKey(event,'offlineToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Data Sync</h3>
          <p class="setting-description">Sync data across devices when online</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch active" id="dataSyncToggle" onclick="toggleDataSync()" role="switch" aria-checked="true" tabindex="0" onkeydown="toggleOnKey(event,'dataSyncToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Privacy & Security -->
    <section class="settings-section">
      <h2 class="section-title">
        <i class="fas fa-shield-alt"></i>
        Privacy & Security
      </h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Data Collection</h3>
          <p class="setting-description">Allow anonymous usage data collection for app improvement</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch" id="dataCollectionToggle" onclick="toggleDataCollection()" role="switch" aria-checked="false" tabindex="0" onkeydown="toggleOnKey(event,'dataCollectionToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3 class="setting-title">Local Storage Only</h3>
          <p class="setting-description">Keep all data on your device only</p>
        </div>
        <div class="setting-control">
          <div class="toggle-switch active" id="localStorageToggle" onclick="toggleLocalStorage()" role="switch" aria-checked="true" tabindex="0" onkeydown="toggleOnKey(event,'localStorageToggle')">
            <div class="toggle-slider" aria-hidden="true"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Actions -->
    <section class="settings-section">
      <h2 class="section-title">
        <i class="fas fa-tools"></i>
        Actions
      </h2>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="exportData()" type="button">
          <i class="fas fa-download" aria-hidden="true"></i>
          Export Data
        </button>
        <button class="btn btn-secondary" onclick="importData()" type="button">
          <i class="fas fa-upload" aria-hidden="true"></i>
          Import Data
        </button>
        <button class="btn btn-secondary" onclick="resetSettings()" type="button">
          <i class="fas fa-undo" aria-hidden="true"></i>
          Reset Settings
        </button>
        <button class="btn btn-danger" onclick="clearAllData()" type="button">
          <i class="fas fa-trash" aria-hidden="true"></i>
          Clear All Data
        </button>
      </div>
    </section>
  </main>

  <script>
    // Debounce helper to avoid frequent localStorage writes
    let saveTimeout = null;
    function debounceSave(delay = 300) {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveSettings();
        saveTimeout = null;
      }, delay);
    }

    // Safe localStorage wrappers
    function safeGetItem(key, fallback = null) {
      try {
        return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback;
      } catch (e) {
        console.warn('localStorage read failed', e);
        return fallback;
      }
    }

    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        console.warn('localStorage write failed', e);
        showNotification('Could not save settings (storage unavailable)', 'error');
        return false;
      }
    }

    // Initialize settings
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      updateThemePreview();

      // Attach keyboard helpers for toggles (in case dynamically added)
      ['darkModeToggle','highContrastToggle','voiceNavToggle','screenReaderToggle','autoSaveToggle','notificationsToggle','offlineToggle','dataSyncToggle','dataCollectionToggle','localStorageToggle'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('keydown', (e)=> toggleOnKey(e,id));
      });
    });

    // Load saved settings
    function loadSettings() {
      const settings = safeGetItem('appSettings', {});

      // Theme settings
      const currentDark = (typeof getDarkMode === 'function') ? getDarkMode() : !!settings.darkMode;
      const d = document.getElementById('darkModeToggle');
      if (d) { d.classList.toggle('active', !!currentDark); d.setAttribute('aria-checked', currentDark ? 'true' : 'false'); }
      if (settings.theme) { selectTheme(settings.theme, false); }
      if (typeof setDarkMode === 'function') setDarkMode(!!currentDark);

      if (settings.fontSize) {
        const fs = document.getElementById('fontSizeRange');
        if (fs) { fs.value = settings.fontSize; updateFontSize(settings.fontSize); }
      }

      // Accessibility settings
      if (settings.highContrast) {
        const hc = document.getElementById('highContrastToggle');
        if (hc) { hc.classList.add('active'); hc.setAttribute('aria-checked','true'); document.body.classList.add('high-contrast'); }
      }

      if (settings.voiceNav) {
        const vn = document.getElementById('voiceNavToggle');
        if (vn) { vn.classList.add('active'); vn.setAttribute('aria-checked','true'); }
      }

      if (settings.screenReader) {
        const sr = document.getElementById('screenReaderToggle');
        if (sr) { sr.classList.add('active'); sr.setAttribute('aria-checked','true'); document.body.classList.add('screen-reader-optimized'); }
      }

      if (settings.animationSpeed) {
        const as = document.getElementById('animationSpeed');
        if (as) { as.value = settings.animationSpeed; updateAnimationSpeed(settings.animationSpeed); }
      }

      // Control settings
      const mapToggle = (key,id, def=true) => {
        const t = document.getElementById(id);
        const val = (settings[key] !== undefined) ? settings[key] : def;
        if (t && val) { t.classList.add('active'); t.setAttribute('aria-checked','true'); }
      };
      mapToggle('autoSave','autoSaveToggle', true);
      mapToggle('notifications','notificationsToggle', true);
      mapToggle('offlineMode','offlineToggle', true);
      mapToggle('dataSync','dataSyncToggle', true);

      // Privacy settings
      if (settings.dataCollection) {
        const dc = document.getElementById('dataCollectionToggle');
        if (dc) { dc.classList.add('active'); dc.setAttribute('aria-checked','true'); }
      }

      const lsDefault = (settings.localStorageOnly !== false);
      const lsEl = document.getElementById('localStorageToggle');
      if (lsEl && lsDefault) { lsEl.classList.add('active'); lsEl.setAttribute('aria-checked','true'); }
    }

    // Save settings (debounced callers preferred)
    function saveSettings() {
      const themeNode = document.querySelector('.theme-option.active');
      const theme = themeNode ? (themeNode.classList.contains('theme-light') ? 'light' :
                     themeNode.classList.contains('theme-dark') ? 'dark' : 'auto') : 'auto';

      const settings = {
        darkMode: !!(document.getElementById('darkModeToggle') && document.getElementById('darkModeToggle').classList.contains('active')),
        theme,
        fontSize: (document.getElementById('fontSizeRange') && document.getElementById('fontSizeRange').value) || 16,
        highContrast: !!(document.getElementById('highContrastToggle') && document.getElementById('highContrastToggle').classList.contains('active')),
        voiceNav: !!(document.getElementById('voiceNavToggle') && document.getElementById('voiceNavToggle').classList.contains('active')),
        screenReader: !!(document.getElementById('screenReaderToggle') && document.getElementById('screenReaderToggle').classList.contains('active')),
        animationSpeed: (document.getElementById('animationSpeed') && document.getElementById('animationSpeed').value) || 'normal',
        autoSave: !!(document.getElementById('autoSaveToggle') && document.getElementById('autoSaveToggle').classList.contains('active')),
        notifications: !!(document.getElementById('notificationsToggle') && document.getElementById('notificationsToggle').classList.contains('active')),
        offlineMode: !!(document.getElementById('offlineToggle') && document.getElementById('offlineToggle').classList.contains('active')),
        dataSync: !!(document.getElementById('dataSyncToggle') && document.getElementById('dataSyncToggle').classList.contains('active')),
        dataCollection: !!(document.getElementById('dataCollectionToggle') && document.getElementById('dataCollectionToggle').classList.contains('active')),
        localStorageOnly: !!(document.getElementById('localStorageToggle') && document.getElementById('localStorageToggle').classList.contains('active'))
      };

      safeSetItem('appSettings', settings);
      showNotification('Settings saved successfully!', 'success');
    }

    // Theme functions with defensive checks
    function selectTheme(theme, save = true) {
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
        option.setAttribute('aria-pressed','false');
      });

      const target = document.querySelector(`.theme-${theme}`);
      if (target) {
        target.classList.add('active');
        target.setAttribute('aria-pressed','true');
      }

      if (theme === 'light') {
        try { localStorage.setItem('darkMode', 'false'); } catch (e) {}
        if (typeof setDarkMode === 'function') setDarkMode(false);
      } else if (theme === 'dark') {
        try { localStorage.setItem('darkMode', 'true'); } catch (e) {}
        if (typeof setDarkMode === 'function') setDarkMode(true);
      } else if (theme === 'auto') {
        const sysDark = (typeof window !== 'undefined' && window.matchMedia) ? window.matchMedia('(prefers-color-scheme: dark)').matches : false;
        try { localStorage.setItem('darkMode', sysDark ? 'true' : 'false'); } catch (e) {}
        if (typeof setDarkMode === 'function') setDarkMode(sysDark);
      }

      if (save) debounceSave();
    }

    function updateThemePreview() {
      // Placeholder for preview update
    }

    // Keyboard helpers for toggles and theme options
    function toggleOnKey(e, id) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const fn = {
          darkModeToggle: toggleDarkMode,
          highContrastToggle: toggleHighContrast,
          voiceNavToggle: toggleVoiceNavigation,
          screenReaderToggle: toggleScreenReader,
          autoSaveToggle: toggleAutoSave,
          notificationsToggle: toggleNotifications,
          offlineToggle: toggleOfflineMode,
          dataSyncToggle: toggleDataSync,
          dataCollectionToggle: toggleDataCollection,
          localStorageToggle: toggleLocalStorage
        }[id];
        if (typeof fn === 'function') fn();
      }
    }

    function optionOnKey(e, theme) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectTheme(theme);
      }
    }

    // Toggle functions updated to set aria attributes and debounce save
    function toggleDarkMode() {
      const toggle = document.getElementById('darkModeToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      const enabled = toggle.classList.contains('active');
      try { localStorage.setItem('darkMode', enabled ? 'true' : 'false'); } catch(e) {}
      if (typeof setDarkMode === 'function') setDarkMode(enabled);
      debounceSave();
    }

    function toggleHighContrast() {
      const toggle = document.getElementById('highContrastToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      document.body.classList.toggle('high-contrast');
      debounceSave();
    }

    function toggleVoiceNavigation() {
      const toggle = document.getElementById('voiceNavToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    function toggleScreenReader() {
      const toggle = document.getElementById('screenReaderToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      document.body.classList.toggle('screen-reader-optimized');
      debounceSave();
    }

    function toggleAutoSave() {
      const toggle = document.getElementById('autoSaveToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    function toggleNotifications() {
      const toggle = document.getElementById('notificationsToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    function toggleOfflineMode() {
      const toggle = document.getElementById('offlineToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    function toggleDataSync() {
      const toggle = document.getElementById('dataSyncToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    function toggleDataCollection() {
      const toggle = document.getElementById('dataCollectionToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    function toggleLocalStorage() {
      const toggle = document.getElementById('localStorageToggle');
      if (!toggle) return;
      toggle.classList.toggle('active');
      toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
      debounceSave();
    }

    // Update functions
    function updateFontSize(size) {
      document.documentElement.style.fontSize = size + 'px';
      const el = document.getElementById('fontSizeValue');
      if (el) { el.textContent = size + 'px'; }
      debounceSave();
    }

    function updateAnimationSpeed(speed) {
      const root = document.documentElement;
      const disable = (speed === 'none');
      if (disable) {
        root.classList.add('reduce-motion');
      } else {
        root.classList.remove('reduce-motion');
      }
      let factor = '1';
      if (speed === 'slow') factor = '1.5';
      else if (speed === 'fast') factor = '0.75';
      root.style.setProperty('--animation-factor', factor);
      debounceSave();
    }
    function showNotification(message, type) {
      const el = document.getElementById('notification');
      if (!el) return;
      el.className = 'notification ' + (type === 'error' ? 'error' : 'success');
      el.textContent = message;
      el.style.display = 'block';
      clearTimeout(el._hideTimer);
      el._hideTimer = setTimeout(function(){ el.style.display = 'none'; }, 2500);
    }
    function exportData() {
      try {
        var keys = ['appSettings','users','remediesData','firstAidData','symptomsData','readFirstAid'];
        var payload = {};
        keys.forEach(function(k){
          try { payload[k] = JSON.parse(localStorage.getItem(k) || 'null'); }
          catch(e){ payload[k] = null; }
        });
        var blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url; a.download = 'healthhub-export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showNotification('Data exported successfully','success');
      } catch(e) {
        showNotification('Export failed','error');
      }
    }
    function importData() {
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = function() {
        var file = input.files && input.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function() {
          try {
            var data = JSON.parse(reader.result || '{}');
            Object.keys(data || {}).forEach(function(k){
              try { localStorage.setItem(k, JSON.stringify(data[k])); } catch(e){}
            });
            showNotification('Data imported','success');
            loadSettings();
          } catch(e) {
            showNotification('Import failed','error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
    function resetSettings() {
      if (!confirm('Reset settings to defaults?')) return;
      try {
        localStorage.removeItem('appSettings');
        var sysDark = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'true' : 'false';
        try { localStorage.setItem('darkMode', sysDark); } catch(e){}
        if (typeof setDarkMode === 'function') setDarkMode(sysDark === 'true');
        selectTheme('auto');
        showNotification('Settings reset','success');
        loadSettings();
      } catch(e) {
        showNotification('Reset failed','error');
      }
    }
    function clearAllData() {
      if (!confirm('Clear all local data? This cannot be undone.')) return;
      try {
        localStorage.clear();
        showNotification('All local data cleared','success');
        loadSettings();
      } catch(e) {
        showNotification('Clear failed','error');
      }
    }
  </script>
</body>
</html>
